{% extends "base.html" %}

{% block title %}Checkout - NIKITA RASOI & BAKES{% endblock %}

{% block content %}
<div class="container py-5">
    <h2 class="text-brown mb-4">
        <i class="fas fa-credit-card me-2"></i>Checkout
    </h2>
    
    <div class="row">
        <div class="col-lg-8">
            <form method="post" action="{{ url_for('place_order') }}">
                <!-- Shipping Address -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-map-marker-alt me-2"></i>Delivery Address</h5>
                    </div>
                    <div class="card-body">
                        {% if addresses %}
                        <div class="mb-3">
                            <label class="form-label">Select Saved Address:</label>
                            {% for address in addresses %}
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="address_id" 
                                       value="{{ address.id }}" id="address{{ address.id }}">
                                <label class="form-check-label" for="address{{ address.id }}">
                                    <strong>{{ address.name }}</strong><br>
                                    {{ address.street }}<br>
                                    {{ address.city }}, {{ address.state }} {{ address.zip_code }}<br>
                                    <small class="text-muted">{{ address.phone }}</small>
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                        <hr>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="address_type" 
                                   value="new" id="newAddress" onclick="toggleNewAddress()">
                            <label class="form-check-label" for="newAddress">
                                Use a different address
                            </label>
                        </div>
                        {% endif %}
                        
                        <div id="newAddressForm" {% if addresses %}style="display:none;"{% endif %}>
                            <div class="mb-3">
                                <label for="new_address" class="form-label">Full Address <span class="text-danger">*</span></label>
                                <textarea class="form-control" id="new_address" name="new_address" rows="3"
                                          placeholder="Enter your complete delivery address" required></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Payment Information -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-credit-card me-2"></i>Payment Method</h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            Choose your preferred payment method. QR verification is required for digital payments.
                        </div>
                        
                        <!-- Payment Method Selection -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <label class="form-label">Select Payment Method:</label>
                                <div class="payment-methods">
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="radio" name="payment_method" value="credit_card" id="credit_card" checked>
                                        <label class="form-check-label" for="credit_card">
                                            <i class="fab fa-cc-visa me-2"></i><i class="fab fa-cc-mastercard me-2"></i>Credit/Debit Card
                                        </label>
                                    </div>
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="radio" name="payment_method" value="paypal" id="paypal">
                                        <label class="form-check-label" for="paypal">
                                            <i class="fab fa-paypal me-2 text-primary"></i>PayPal
                                        </label>
                                    </div>
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="radio" name="payment_method" value="apple_pay" id="apple_pay">
                                        <label class="form-check-label" for="apple_pay">
                                            <i class="fab fa-apple-pay me-2"></i>Apple Pay
                                        </label>
                                    </div>
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="radio" name="payment_method" value="google_pay" id="google_pay">
                                        <label class="form-check-label" for="google_pay">
                                            <i class="fab fa-google-pay me-2"></i>Google Pay
                                        </label>
                                    </div>
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="radio" name="payment_method" value="crypto" id="crypto">
                                        <label class="form-check-label" for="crypto">
                                            <i class="fab fa-bitcoin me-2 text-warning"></i>Cryptocurrency
                                        </label>
                                    </div>
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="radio" name="payment_method" value="bank_transfer" id="bank_transfer">
                                        <label class="form-check-label" for="bank_transfer">
                                            <i class="fas fa-university me-2"></i>Bank Transfer
                                        </label>
                                    </div>
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="radio" name="payment_method" value="cash_on_delivery" id="cash_on_delivery">
                                        <label class="form-check-label" for="cash_on_delivery">
                                            <i class="fas fa-money-bill-wave me-2 text-success"></i>Cash on Delivery
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Credit Card Details -->
                        <div id="credit_card_details" class="payment-details">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="cardName" class="form-label">Cardholder Name</label>
                                    <input type="text" class="form-control" id="cardName" placeholder="John Doe">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="cardNumber" class="form-label">Card Number</label>
                                    <input type="text" class="form-control" id="cardNumber" placeholder="1234 5678 9012 3456">
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="expiry" class="form-label">Expiry Date</label>
                                    <input type="text" class="form-control" id="expiry" placeholder="MM/YY">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="cvv" class="form-label">CVV</label>
                                    <input type="text" class="form-control" id="cvv" placeholder="123">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="cardType" class="form-label">Card Type</label>
                                    <select class="form-select" id="cardType">
                                        <option>Visa</option>
                                        <option>Mastercard</option>
                                        <option>American Express</option>
                                        <option>Discover</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Digital Payment Details -->
                        <div id="digital_payment_details" class="payment-details" style="display: none;">
                            <div class="alert alert-warning">
                                <i class="fas fa-qrcode me-2"></i>
                                QR code verification will be required for this payment method.
                            </div>
                        </div>
                        
                        <!-- Cash on Delivery Details -->
                        <div id="cash_delivery_details" class="payment-details" style="display: none;">
                            <div class="alert alert-success">
                                <i class="fas fa-info-circle me-2"></i>
                                Payment will be collected upon delivery. Please have exact change ready.
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Special Instructions -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-comment me-2"></i>Special Instructions</h5>
                    </div>
                    <div class="card-body">
                        <textarea class="form-control" rows="3" placeholder="Any special delivery instructions or notes..."></textarea>
                    </div>
                </div>
                
                <button type="submit" class="btn btn-brown btn-lg" id="placeOrderBtn">
                    <i class="fas fa-shopping-bag me-2"></i>Place Order
                </button>
            </form>
        </div>
        
        <div class="col-lg-4">
            <!-- Order Summary -->
            <div class="card">
                <div class="card-header bg-brown text-white">
                    <h5 class="mb-0">Order Summary</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Items ({{ cart_count }}):</span>
                        <span>₹{{ "%.2f"|format(cart_total) }}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Delivery Fee:</span>
                        <span>₹50.00</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Tax (18%):</span>
                        <span>₹{{ "%.2f"|format((cart_total + 50.00) * 0.18) }}</span>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between mb-3">
                        <strong>Total:</strong>
                        <strong class="text-brown">₹{{ "%.2f"|format((cart_total + 50.00) * 1.18) }}</strong>
                    </div>
                </div>
            </div>
            
            <!-- Security Notice -->
            <div class="card mt-3">
                <div class="card-body">
                    <h6 class="card-title"><i class="fas fa-shield-alt me-2"></i>Secure Checkout</h6>
                    <ul class="list-unstyled small">
                        <li><i class="fas fa-check text-success me-2"></i>SSL encrypted</li>
                        <li><i class="fas fa-check text-success me-2"></i>PCI compliant</li>
                        <li><i class="fas fa-check text-success me-2"></i>Money-back guarantee</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- QR Code Verification Modal -->
<div class="modal fade" id="qrVerificationModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-qrcode me-2"></i>Payment Verification
                </h5>
                <div class="timer-display">
                    <span class="badge bg-warning fs-6" id="qrTimer">2:00</span>
                </div>
            </div>
            <div class="modal-body text-center">
                <div id="qrCodeContainer">
                    <div class="mb-4">
                        <h4 class="text-brown">Scan QR Code to Complete Payment</h4>
                        <p class="text-muted">Use your mobile device to scan the QR code below</p>
                    </div>
                    
                    <!-- QR Code Display -->
                    <div class="qr-code-wrapper mb-4">
                        <div id="qrCode" class="qr-code">
                            <!-- QR code will be generated here -->
                            <div class="qr-placeholder">
                                <canvas id="qrCanvas" width="200" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-mobile-alt me-2"></i>
                        Open your payment app and scan this QR code to authorize the transaction
                    </div>
                </div>
                
                <!-- Screenshot Upload -->
                <div id="screenshotUpload" style="display: none;">
                    <div class="alert alert-warning">
                        <i class="fas fa-clock me-2"></i>
                        Time expired! Please upload a screenshot of your payment confirmation for verification.
                    </div>
                    
                    <div class="mb-3">
                        <label for="paymentScreenshot" class="form-label">Upload Payment Screenshot</label>
                        <input type="file" class="form-control" id="paymentScreenshot" accept="image/*" required>
                        <small class="form-text text-muted">Accepted formats: JPG, PNG, GIF (Max 5MB)</small>
                    </div>
                    
                    <div class="screenshot-preview" id="screenshotPreview" style="display: none;">
                        <img id="previewImage" src="" alt="Screenshot Preview" class="img-fluid rounded mb-3" style="max-height: 200px;">
                    </div>
                </div>
                
                <!-- Payment Status -->
                <div id="paymentStatus" class="payment-status" style="display: none;">
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle me-2"></i>
                        Payment verification submitted successfully!
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <div id="qrActions">
                    <button type="button" class="btn btn-secondary" id="cancelPayment">Cancel Payment</button>
                    <button type="button" class="btn btn-brown" id="refreshQR">
                        <i class="fas fa-sync-alt me-2"></i>Refresh QR Code
                    </button>
                </div>
                <div id="uploadActions" style="display: none;">
                    <button type="button" class="btn btn-secondary" id="cancelUpload">Cancel</button>
                    <button type="button" class="btn btn-success" id="submitScreenshot">
                        <i class="fas fa-upload me-2"></i>Submit Verification
                    </button>
                </div>
                <div id="processingActions" style="display: none;">
                    <button type="button" class="btn btn-brown" id="proceedToOrder">
                        <i class="fas fa-arrow-right me-2"></i>Complete Order
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Enhanced Checkout JavaScript with QR Verification
class CheckoutManager {
    constructor() {
        this.qrTimer = null;
        this.qrTimeLeft = 120; // 2 minutes in seconds
        this.qrModal = null;
        this.init();
    }

    init() {
        this.bindEvents();
        this.initializePaymentMethods();
        this.qrModal = new bootstrap.Modal(document.getElementById('qrVerificationModal'));
    }

    bindEvents() {
        // Payment method change
        document.querySelectorAll('input[name="payment_method"]').forEach(radio => {
            radio.addEventListener('change', (e) => this.handlePaymentMethodChange(e));
        });

        // Form submission
        document.getElementById('placeOrderBtn').addEventListener('click', (e) => {
            e.preventDefault();
            this.handleOrderSubmission();
        });

        // QR Modal events
        document.getElementById('refreshQR').addEventListener('click', () => this.generateQRCode());
        document.getElementById('cancelPayment').addEventListener('click', () => this.closeQRModal());
        document.getElementById('cancelUpload').addEventListener('click', () => this.closeQRModal());
        document.getElementById('submitScreenshot').addEventListener('click', () => this.submitScreenshot());
        document.getElementById('proceedToOrder').addEventListener('click', () => this.completeOrder());

        // Screenshot upload
        document.getElementById('paymentScreenshot').addEventListener('change', (e) => this.handleScreenshotUpload(e));

        // Address form toggle
        if (document.getElementById('newAddress')) {
            document.getElementById('newAddress').addEventListener('change', () => this.toggleNewAddress());
        }

        // Card formatting
        this.initializeCardFormatting();
    }

    handlePaymentMethodChange(e) {
        const method = e.target.value;
        const digitalMethods = ['paypal', 'apple_pay', 'google_pay', 'crypto', 'bank_transfer'];
        
        // Hide all payment details
        document.querySelectorAll('.payment-details').forEach(div => {
            div.style.display = 'none';
        });

        // Show relevant payment details
        if (method === 'credit_card') {
            document.getElementById('credit_card_details').style.display = 'block';
        } else if (digitalMethods.includes(method)) {
            document.getElementById('digital_payment_details').style.display = 'block';
        } else if (method === 'cash_on_delivery') {
            document.getElementById('cash_delivery_details').style.display = 'block';
        }
    }

    handleOrderSubmission() {
        const selectedMethod = document.querySelector('input[name="payment_method"]:checked').value;
        const digitalMethods = ['paypal', 'apple_pay', 'google_pay', 'crypto', 'bank_transfer'];
        
        if (digitalMethods.includes(selectedMethod)) {
            this.showQRVerification(selectedMethod);
        } else {
            this.submitOrder();
        }
    }

    showQRVerification(paymentMethod) {
        // Update modal title with payment method
        document.querySelector('#qrVerificationModal .modal-title').innerHTML = 
            `<i class="fas fa-qrcode me-2"></i>${this.getPaymentMethodName(paymentMethod)} Verification`;
        
        // Reset modal state
        document.getElementById('qrCodeContainer').style.display = 'block';
        document.getElementById('screenshotUpload').style.display = 'none';
        document.getElementById('paymentStatus').style.display = 'none';
        document.getElementById('qrActions').style.display = 'block';
        document.getElementById('uploadActions').style.display = 'none';
        document.getElementById('processingActions').style.display = 'none';
        
        // Show modal and start timer
        this.qrModal.show();
        this.generateQRCode();
        this.startQRTimer();
    }

    generateQRCode() {
        const canvas = document.getElementById('qrCanvas');
        const ctx = canvas.getContext('2d');
        
        // Clear canvas
        ctx.clearRect(0, 0, 200, 200);
        
        // Generate simple QR-like pattern (demo)
        ctx.fillStyle = '#000';
        for (let i = 0; i < 20; i++) {
            for (let j = 0; j < 20; j++) {
                if (Math.random() > 0.5) {
                    ctx.fillRect(i * 10, j * 10, 10, 10);
                }
            }
        }
        
        // Add corner markers
        this.drawCornerMarker(ctx, 0, 0);
        this.drawCornerMarker(ctx, 140, 0);
        this.drawCornerMarker(ctx, 0, 140);
        
        // Add center circle
        ctx.beginPath();
        ctx.arc(100, 100, 15, 0, 2 * Math.PI);
        ctx.fill();
    }

    drawCornerMarker(ctx, x, y) {
        ctx.fillStyle = '#000';
        ctx.fillRect(x, y, 60, 60);
        ctx.fillStyle = '#fff';
        ctx.fillRect(x + 10, y + 10, 40, 40);
        ctx.fillStyle = '#000';
        ctx.fillRect(x + 20, y + 20, 20, 20);
    }

    startQRTimer() {
        this.qrTimeLeft = 120;
        this.updateTimerDisplay();
        
        this.qrTimer = setInterval(() => {
            this.qrTimeLeft--;
            this.updateTimerDisplay();
            
            if (this.qrTimeLeft <= 0) {
                this.handleQRTimeout();
            }
        }, 1000);
    }

    updateTimerDisplay() {
        const minutes = Math.floor(this.qrTimeLeft / 60);
        const seconds = this.qrTimeLeft % 60;
        const timeString = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        document.getElementById('qrTimer').textContent = timeString;
        
        // Change color as time runs out
        const timerElement = document.getElementById('qrTimer');
        if (this.qrTimeLeft <= 30) {
            timerElement.className = 'badge bg-danger fs-6';
        } else if (this.qrTimeLeft <= 60) {
            timerElement.className = 'badge bg-warning fs-6';
        }
    }

    handleQRTimeout() {
        clearInterval(this.qrTimer);
        
        // Hide QR code and show screenshot upload
        document.getElementById('qrCodeContainer').style.display = 'none';
        document.getElementById('screenshotUpload').style.display = 'block';
        document.getElementById('qrActions').style.display = 'none';
        document.getElementById('uploadActions').style.display = 'block';
    }

    handleScreenshotUpload(e) {
        const file = e.target.files[0];
        if (file) {
            if (file.size > 5 * 1024 * 1024) { // 5MB limit
                alert('File size must be less than 5MB');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('previewImage').src = e.target.result;
                document.getElementById('screenshotPreview').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }
    }

    submitScreenshot() {
        const file = document.getElementById('paymentScreenshot').files[0];
        if (!file) {
            alert('Please select a screenshot to upload');
            return;
        }
        
        // Simulate upload process
        this.showLoadingState('Verifying screenshot...');
        
        setTimeout(() => {
            document.getElementById('screenshotUpload').style.display = 'none';
            document.getElementById('paymentStatus').style.display = 'block';
            document.getElementById('uploadActions').style.display = 'none';
            document.getElementById('processingActions').style.display = 'block';
        }, 2000);
    }

    completeOrder() {
        this.closeQRModal();
        this.submitOrder();
    }

    closeQRModal() {
        if (this.qrTimer) {
            clearInterval(this.qrTimer);
        }
        this.qrModal.hide();
    }

    submitOrder() {
        const form = document.querySelector('form');
        const formData = new FormData(form);
        
        // Add payment method info
        const paymentMethod = document.querySelector('input[name="payment_method"]:checked').value;
        formData.append('payment_method', paymentMethod);
        
        // Show loading state
        this.showLoadingState('Processing your order...');
        
        // Submit with AJAX to prevent page reload
        fetch('/place_order', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (response.ok) {
                return response.text();
            }
            throw new Error('Order submission failed');
        })
        .then(html => {
            // Parse response to check for success/error
            if (html.includes('Order #') && html.includes('placed successfully')) {
                // Clear the cart display immediately
                this.clearCartDisplay();
                this.showSuccessMessage('Order placed successfully!');
                setTimeout(() => {
                    window.location.href = '/orders';
                }, 2000);
            } else {
                // Parse and show any error messages
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const alerts = doc.querySelectorAll('.alert-danger');
                if (alerts.length > 0) {
                    this.showErrorMessage(alerts[0].textContent.trim());
                } else {
                    window.location.reload();
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            this.showErrorMessage('Failed to place order. Please try again.');
        })
        .finally(() => {
            this.hideLoadingState();
        });
    }

    showLoadingState(message) {
        const btn = document.getElementById('placeOrderBtn');
        btn.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>${message}`;
        btn.disabled = true;
    }

    hideLoadingState() {
        const btn = document.getElementById('placeOrderBtn');
        btn.innerHTML = '<i class="fas fa-shopping-bag me-2"></i>Place Order';
        btn.disabled = false;
    }

    showSuccessMessage(message) {
        this.showNotification(message, 'success');
    }

    showErrorMessage(message) {
        this.showNotification(message, 'danger');
    }

    clearCartDisplay() {
        // Update cart count in navbar
        const cartBadge = document.querySelector('.navbar .badge');
        if (cartBadge) {
            cartBadge.textContent = '0';
            cartBadge.style.display = 'none';
        }
        
        // Update cart total display
        const cartTotalElements = document.querySelectorAll('.cart-total');
        cartTotalElements.forEach(element => {
            element.textContent = '₹0.00';
        });
        
        // Update cart count display
        const cartCountElements = document.querySelectorAll('.cart-count');
        cartCountElements.forEach(element => {
            element.textContent = '0';
        });
    }

    showNotification(message, type) {
        const notification = document.createElement('div');
        notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        notification.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 5000);
    }

    getPaymentMethodName(method) {
        const names = {
            'paypal': 'PayPal',
            'apple_pay': 'Apple Pay',
            'google_pay': 'Google Pay',
            'crypto': 'Cryptocurrency',
            'bank_transfer': 'Bank Transfer'
        };
        return names[method] || method;
    }

    toggleNewAddress() {
        const newAddressForm = document.getElementById('newAddressForm');
        const newAddressRadio = document.getElementById('newAddress');
        
        if (newAddressRadio.checked) {
            newAddressForm.style.display = 'block';
            document.querySelectorAll('input[name="address_id"]').forEach(radio => {
                radio.checked = false;
            });
        } else {
            newAddressForm.style.display = 'none';
        }
    }

    initializeCardFormatting() {
        // Format card number
        const cardNumber = document.getElementById('cardNumber');
        if (cardNumber) {
            cardNumber.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\s+/g, '').replace(/[^0-9]/gi, '');
                let formattedValue = value.match(/\d{1,4}/g)?.join(' ') || value;
                e.target.value = formattedValue;
            });
        }

        // Format expiry date
        const expiry = document.getElementById('expiry');
        if (expiry) {
            expiry.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length >= 2) {
                    value = value.substring(0, 2) + '/' + value.substring(2, 4);
                }
                e.target.value = value;
            });
        }

        // CVV validation
        const cvv = document.getElementById('cvv');
        if (cvv) {
            cvv.addEventListener('input', function(e) {
                e.target.value = e.target.value.replace(/\D/g, '').substring(0, 4);
            });
        }
    }

    initializePaymentMethods() {
        // Set initial payment method display
        const selectedMethod = document.querySelector('input[name="payment_method"]:checked');
        if (selectedMethod) {
            this.handlePaymentMethodChange({ target: selectedMethod });
        }
    }
}

// Initialize checkout manager when DOM is ready
document.addEventListener('DOMContentLoaded', () => {
    window.checkoutManager = new CheckoutManager();
});

// Legacy functions for compatibility
function toggleNewAddress() {
    if (window.checkoutManager) {
        window.checkoutManager.toggleNewAddress();
    }
}
</script>
{% endblock %}
